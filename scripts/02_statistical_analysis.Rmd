---
title: "Sjogren Bacterial Diversity Analysis"
author: "Maria J.Rus"
date: "`r Sys.Date()`"
output: html_document
---

# Knitr Setup
```{r}
### ===================
###   Knitr setup
### ===================

# Load the knitr library for dynamic report generation
library(knitr)

# Set global chunk options for knitr
opts_chunk$set(
  tidy = FALSE,       # Do not reformat code in chunks
  cache = TRUE,       # Enable caching to speed up knitting
  echo = FALSE,       # Do not display the R code in the output
  warning = FALSE,    # Suppress warnings in the output
  message = FALSE,    # Suppress messages in the output
  dpi = 300,          # Set the resolution of plots
  fig.width = 8,      # Set the width of the figures
  fig.height = 8,     # Set the height of the figures
  fig.align = "center" # Center align the figures
)

```


# R Packages
```{r}
### ===================
###   R packages
### ===================

# Load packages for data manipulation and cleaning
library(readr)        # Read delimited files
library(janitor)      # Clean and format data

# Load packages for phylogenetic and ecological analysis
library(vegan)        # Community ecology analysis, including diversity and ordination
library(ape)          # Analyses of Phylogenetics and Evolution

# Load packages for data manipulation and visualization
library(tidyverse)    # Data science packages including ggplot2, dplyr, and others
library(dplyr)        # Data manipulation
library(tibble)       # Data frames
library(ggplot2)      # Data visualization
library(ggbeeswarm)   # Pretty beeswarm plots
library(ggthemes)     # Additional themes for ggplot2
library(reshape2)     # Reshape data
library(viridis)      # Color palettes
library(RColorBrewer) # Color palettes
library(ggrepel)      # Repel overlapping text labels
library(ggsci)        # Scientific journal color palettes
library(ggpubr)       # Publication-ready plots
library(purrr)        # Functional programming tools

```


# Define Constants
```{r}
### ===========================
###   Define constants
### ===========================

# Set the working directory root path
# Option 1: Use here package for project-relative paths (recommended)
# library(here)
# root_dir <- here()

# Option 2: Set manually (update this path for your system)
root_dir <- getwd()  # Uses current working directory

# File path for species abundance table obtained from Kraken2-Bracken analysis
# This file is generated by 01_taxonomic_classification.sh
abundance_file_fp <- file.path(root_dir, "data", "species_abundance.tsv")

```


# Theme for Plots
```{r}
### ===========================
###   Define theme for plots
### ===========================

# Define a custom theme for boxplots
theme_set(theme_classic() + theme(
  axis.line.x = element_line(colour = 'black', linewidth=0.5, linetype='solid'),
  axis.line.y = element_line(colour = 'black', linewidth=0.5, linetype='solid')))

theme_boxplot <- function () {
  theme_base(base_size = 12) +
  theme(line = element_line(linewidth=0.8),
        text = element_text(size = 18),
        axis.text.x = element_text(color="black"),
        axis.text.y = element_text(color="black"),
        plot.background = element_blank(),
        panel.border = element_rect(colour = "black", size = 0.8)
  )
}

```


#-------------------------------

# Data Preparation

## Read and Process Species Abundance Data
```{r}
### ===========================
###   Read species abundance table
### ===========================

# Read the species abundance table from Kraken2-Bracken output
# The first column contains species names, and subsequent columns are samples
abundance_raw <- read_tsv(abundance_file_fp)

# Display the dimensions of the raw abundance table
cat("Raw abundance table dimensions:", dim(abundance_raw), "\n")
cat("Number of species:", nrow(abundance_raw), "\n")
cat("Number of samples:", ncol(abundance_raw) - 1, "\n")

```

```{r}
### ===========================
###   Transform data to long format
### ===========================

# Transform the abundance table from wide to long format
# This makes it easier to work with in R and join with metadata
abundance_long <- abundance_raw %>%
  # Rename the first column to 'Species' for clarity
  rename(Species = 1) %>%
  # Convert to long format: each row is one species in one sample
  pivot_longer(
    cols = -Species,
    names_to = "SampleID",
    values_to = "Abundance"
  ) %>%
  # Remove the "_SSA" suffix from SampleID for cleaner labels
  mutate(SampleID = str_replace(SampleID, "_SSA$", "")) %>%
  mutate(SampleID = str_replace(SampleID, "_SA$", ""))

```

```{r}
### ===========================
###   Create metadata from sample names
### ===========================

# Extract metadata information from sample IDs
# Cases (Sjogren): SubjectID starts with "US" or "SS"
# Controls: SubjectID starts with "C"
metadata <- abundance_long %>%
  dplyr::select(SampleID) %>%
  distinct() %>%
  mutate(
    # Determine group based on the first letter(s) of the sample ID
    Group = case_when(
      str_detect(SampleID, "^US") ~ "Control",
      str_detect(SampleID, "^SS") ~ "Sjogren",
      str_detect(SampleID, "^C") ~ "Control",
      TRUE ~ "Unknown"
    )
  ) %>%
  # Remove any unknown samples
  filter(Group != "Unknown")

# Display sample counts per group
cat("\nSample distribution:\n")
table(metadata$Group)

```

```{r}
### ===========================
###   Filter and normalize abundance data
### ===========================

# Filter abundance data to keep only samples with metadata
abundance_filtered <- abundance_long %>%
  filter(SampleID %in% metadata$SampleID) %>%
  # Calculate relative abundance (proportions sum to 1 per sample)
  group_by(SampleID) %>%
  mutate(RelativeAbundance = Abundance / sum(Abundance)) %>%
  ungroup()

# Merge with metadata
abundance_data <- abundance_filtered %>%
  left_join(metadata, by = "SampleID")

# Create a wide format abundance matrix for diversity calculations
abundance_matrix <- abundance_filtered %>%
  dplyr::select(Species, SampleID, Abundance) %>%
  pivot_wider(
    names_from = Species,
    values_from = Abundance,
    values_fill = 0
  ) %>%
  column_to_rownames("SampleID")

# Create relative abundance matrix
rel_abundance_matrix <- abundance_filtered %>%
  dplyr::select(Species, SampleID, RelativeAbundance) %>%
  pivot_wider(
    names_from = Species,
    values_from = RelativeAbundance,
    values_fill = 0
  ) %>%
  column_to_rownames("SampleID")

```


#-------------------------------

# Taxonomic Composition

## Top 20 Most Abundant Species
```{r}
### ===========================
###   Identify top 20 species
### ===========================

# Calculate mean relative abundance for each species across all samples
top_species <- abundance_data %>%
  group_by(Species, Group) %>%
  summarize(MeanAbundance = mean(RelativeAbundance), .groups = "drop") %>%
  group_by(Species) %>%
  summarize(OverallMean = mean(MeanAbundance), .groups = "drop") %>%
  arrange(desc(OverallMean)) %>%
  slice(1:20) %>%
  pull(Species)

```

```{r fig.width=12, fig.height=8}
### ===========================
###   Barplot: Top 20 species by group (mean comparison)
### ===========================

# Prepare data for barplot: top 20 species, grouped by Sjogren vs Control
plot_data <- abundance_data %>%
  # Keep only top 20 species
  filter(Species %in% top_species) %>%
  # Calculate mean relative abundance per species and group
  group_by(Species, Group) %>%
  summarize(MeanRelativeAbundance = mean(RelativeAbundance), .groups = "drop") %>%
  # Order species by overall abundance
  mutate(Species = factor(Species, levels = rev(top_species)))

# Define color palette for the two groups
group_colors <- c("Sjogren" = "#0067b8", "Control" = "#ff627c")

# Create grouped barplot
barplot_top20 <- ggplot(plot_data, aes(x = Species, y = MeanRelativeAbundance, fill = Group)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), alpha = 0.85, color = "black", linewidth = 0.3) +
  scale_fill_manual(values = group_colors) +
  coord_flip() +
  labs(
    x = "Species",
    y = "Mean Relative Abundance",
    title = "Top 20 Most Abundant Species: Sjogren vs Control",
    fill = "Group"
  ) +
  theme_boxplot() +
  theme(
    text = element_text(size = 14),
    axis.text.y = element_text(size = 11, face = "italic"),
    axis.title = element_text(size = 15, face = "bold"),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    legend.position = "right",
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 12)
  )

print(barplot_top20)

# Save the plot
ggsave(file.path(root_dir, "Top20_Species_Barplot_Grouped.pdf"),
       plot = barplot_top20,
       device = "pdf",
       width = 12,
       height = 8,
       units = "in")

```

## Stacked Barplot - Individual Sample Composition
```{r}
### ===========================
###   Prepare data for stacked barplot
### ===========================

# Prepare data: top 20 species + "Other" category for each individual sample
taxa_stacked <- abundance_data %>%
  # Lump species outside top 20 into "Other"
  mutate(Species_Lumped = fct_lump(Species, n = 19, w = RelativeAbundance, other_level = "Other")) %>%
  # Re-normalize proportions after lumping (to ensure they sum to 1)
  group_by(SampleID) %>%
  mutate(Proportion = RelativeAbundance / sum(RelativeAbundance)) %>%
  ungroup() %>%
  # Sum proportions for each species category per sample
  group_by(SampleID, Species_Lumped, Group) %>%
  summarize(Proportion = sum(Proportion), .groups = "drop")

# Define group labels for facets
group_names <- c(`Sjogren` = "Sjogren", `Control` = "Control")

```

```{r}
### ===========================
###   Define color palette for species
### ===========================

# Define a color palette for the top 20 species + Other (21 colors total)
species_palette <- c(
  "#1F77B4FF", "#FF7F0EFF", "#2CA02CFF", "#D62728FF", "#9467BDFF",
  "#8C564BFF", "#E377C2FF", "#7F7F7FFF", "#BCBD22FF", "#17BECFFF",
  "#AEC7E8FF", "#FFBB78FF", "#98DF8AFF", "#FF9896FF", "#C5B0D5FF",
  "#C49C94FF", "#F7B6D2FF", "#DBDB8DFF", "#9EDAE5FF", "#C7C7C7FF" # Color for "Other" category
)

```

```{r fig.width=16, fig.height=8}
### ===========================
###   Stacked barplot of individual samples
### ===========================

# Create stacked barplot showing composition of each individual sample
stacked_barplot <- taxa_stacked %>%
  # Order groups
  mutate(Group = fct_relevel(Group, "Control", "Sjogren")) %>%
  # Create the plot
  ggplot(aes(x = reorder(SampleID, Proportion, decreasing = FALSE), y = Proportion)) +
  geom_col(aes(fill = fct_relevel(Species_Lumped, "Other", after = Inf)), width = 1, color = NA) +
  scale_fill_manual(values = species_palette) + # Comment if n > 19
  labs(
    x = "Sample",
    y = "Relative Abundance",
    fill = "Species"
  ) +
  facet_grid(~ Group, scales = "free_x", space = "free_x", labeller = as_labeller(group_names)) +
  theme_minimal(base_size = 16) +
  theme(
    panel.spacing.x = unit(0.5, "lines"),
    axis.title.x = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.text.y = element_text(color = "black", margin = margin(t = 0, r = 5, b = 0, l = 0)),
    axis.title.y = element_text(size = 18, face = "bold", color = "black"),
    strip.text.x = element_text(size = 20, vjust = 0.5, hjust = 0.5, face = "bold",
                                margin = margin(t = 5, r = 0, b = 5, l = 0)),
    strip.background = element_rect(fill = "grey90", color = "black", linewidth = 0.8),
    legend.position = "right",
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 11, face = "italic"),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 0.8),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )

print(stacked_barplot)

# Save the plot
ggsave(file.path(root_dir, "Top20_Species_Stacked_Barplot.pdf"),
       plot = stacked_barplot,
       device = "pdf",
       width = 16,
       height = 8,
       units = "in")

```

```{r}
### ===========================
###   Summary statistics for top species
### ===========================

# Calculate summary statistics for top 20 species
top_species_summary <- abundance_data %>%
  filter(Species %in% top_species) %>%
  group_by(Species, Group) %>%
  summarize(
    Mean = mean(RelativeAbundance),
    SD = sd(RelativeAbundance),
    Median = median(RelativeAbundance),
    IQR = IQR(RelativeAbundance),
    .groups = "drop"
  ) %>%
  arrange(desc(Mean))

# Display the summary table
print(top_species_summary)

# Write to file
write_tsv(top_species_summary,
          file.path(root_dir, "Top20_Species_Summary_Statistics.tsv"))

```


#-------------------------------

# Alpha Diversity Analysis

## Calculate Alpha Diversity Metrics
```{r}
### ===========================
###   Calculate alpha diversity indices
### ===========================

# Calculate various alpha diversity metrics for each sample
# Using the vegan package

alpha_diversity <- data.frame(
  SampleID = rownames(abundance_matrix),
  # Shannon diversity: accounts for both abundance and evenness
  Shannon = diversity(abundance_matrix, index = "shannon"),
  # Simpson diversity: probability that two randomly selected individuals belong to different species
  Simpson = diversity(abundance_matrix, index = "simpson"),
  # Inverse Simpson: more intuitive interpretation (higher = more diverse)
  InvSimpson = diversity(abundance_matrix, index = "invsimpson"),
  # Species richness: total number of species observed
  Richness = specnumber(abundance_matrix),
  # Pielou's evenness: Shannon diversity divided by log of richness
  Evenness = diversity(abundance_matrix, index = "shannon") / log(specnumber(abundance_matrix))
) %>%
  # Join with metadata to add group information
  left_join(metadata, by = "SampleID")

# Display summary statistics
cat("\nAlpha diversity summary by group:\n")
alpha_diversity %>%
  group_by(Group) %>%
  summarize(
    Shannon_Mean = mean(Shannon),
    Shannon_SD = sd(Shannon),
    Richness_Mean = mean(Richness),
    Richness_SD = sd(Richness),
    InvSimpson_Mean = mean(InvSimpson),
    InvSimpson_SD = sd(InvSimpson),
    .groups = "drop"
  )

```

## Shannon Diversity Comparison
```{r fig.width=6, fig.height=6}
### ===========================
###   Plot Shannon diversity
### ===========================

# Create boxplot for Shannon diversity
shannon_plot <- ggplot(alpha_diversity, aes(x = Group, y = Shannon, fill = Group)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.7, color = "black", linewidth = 0.6) +
  geom_beeswarm(aes(color = Group), alpha = 0.6, size = 3, cex = 3) +
  scale_fill_manual(values = group_colors) +
  scale_color_manual(values = group_colors) +
  labs(
    x = "",
    y = "Shannon Diversity Index",
    title = "Alpha Diversity: Shannon Index"
  ) +
  theme_boxplot() +
  theme(
    text = element_text(size = 14),
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    legend.position = "none"
  )

print(shannon_plot)

```

## Species Richness Comparison
```{r fig.width=6, fig.height=6}
### ===========================
###   Plot species richness
### ===========================

# Create boxplot for species richness
richness_plot <- ggplot(alpha_diversity, aes(x = Group, y = Richness, fill = Group)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.7, color = "black", linewidth = 0.6) +
  geom_beeswarm(aes(color = Group), alpha = 0.6, size = 3, cex = 3) +
  scale_fill_manual(values = group_colors) +
  scale_color_manual(values = group_colors) +
  labs(
    x = "",
    y = "Species Richness",
    title = "Alpha Diversity: Species Richness"
  ) +
  theme_boxplot() +
  theme(
    text = element_text(size = 14),
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    legend.position = "none"
  )

print(richness_plot)

```

## Inverse Simpson Diversity Comparison
```{r fig.width=6, fig.height=6}
### ===========================
###   Plot Inverse Simpson diversity
### ===========================

# Create boxplot for Inverse Simpson diversity
invsimpson_plot <- ggplot(alpha_diversity, aes(x = Group, y = InvSimpson, fill = Group)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.7, color = "black", linewidth = 0.6) +
  geom_beeswarm(aes(color = Group), alpha = 0.6, size = 3, cex = 3) +
  scale_fill_manual(values = group_colors) +
  scale_color_manual(values = group_colors) +
  labs(
    x = "",
    y = "Inverse Simpson Index",
    title = "Alpha Diversity: Inverse Simpson Index"
  ) +
  theme_boxplot() +
  theme(
    text = element_text(size = 14),
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    legend.position = "none"
  )

print(invsimpson_plot)

```

## Combined Alpha Diversity Plot
```{r fig.width=12, fig.height=5}
### ===========================
###   Combine alpha diversity plots
### ===========================

# Arrange Shannon, Richness, and Inverse Simpson plots side by side
combined_alpha <- ggarrange(
  shannon_plot,
  richness_plot,
  invsimpson_plot,
  ncol = 3,
  nrow = 1,
  common.legend = FALSE
)

print(combined_alpha)

# Save the combined plot
ggsave(file.path(root_dir, "Alpha_Diversity_Combined.pdf"),
       plot = combined_alpha,
       device = "pdf",
       width = 12,
       height = 5,
       units = "in")

```

## Statistical Tests for Alpha Diversity
```{r}
### ===========================
###   Statistical tests for alpha diversity
### ===========================

# Perform Wilcoxon rank-sum test (Mann-Whitney U test) for each metric
# This is appropriate for comparing two independent groups

# Shannon diversity test
shannon_test <- wilcox.test(Shannon ~ Group, data = alpha_diversity)
cat("\n=== Shannon Diversity Test ===\n")
cat("Wilcoxon rank-sum test (Mann-Whitney U)\n")
cat("W =", shannon_test$statistic, "\n")
cat("p-value =", shannon_test$p.value, "\n")
if (shannon_test$p.value < 0.05) {
  cat("Result: Significant difference (p < 0.05)\n")
} else {
  cat("Result: No significant difference (p >= 0.05)\n")
}

# Species richness test
richness_test <- wilcox.test(Richness ~ Group, data = alpha_diversity)
cat("\n=== Species Richness Test ===\n")
cat("Wilcoxon rank-sum test (Mann-Whitney U)\n")
cat("W =", richness_test$statistic, "\n")
cat("p-value =", richness_test$p.value, "\n")
if (richness_test$p.value < 0.05) {
  cat("Result: Significant difference (p < 0.05)\n")
} else {
  cat("Result: No significant difference (p >= 0.05)\n")
}

# Inverse Simpson diversity test
invsimpson_test <- wilcox.test(InvSimpson ~ Group, data = alpha_diversity)
cat("\n=== Inverse Simpson Diversity Test ===\n")
cat("Wilcoxon rank-sum test (Mann-Whitney U)\n")
cat("W =", invsimpson_test$statistic, "\n")
cat("p-value =", invsimpson_test$p.value, "\n")
if (invsimpson_test$p.value < 0.05) {
  cat("Result: Significant difference (p < 0.05)\n")
} else {
  cat("Result: No significant difference (p >= 0.05)\n")
}

# Create summary table of statistical tests
alpha_stats <- data.frame(
  Metric = c("Shannon", "Richness", "InvSimpson"),
  Test_Statistic = c(shannon_test$statistic, richness_test$statistic, invsimpson_test$statistic),
  P_value = c(shannon_test$p.value, richness_test$p.value, invsimpson_test$p.value),
  Significant = c(shannon_test$p.value < 0.05, richness_test$p.value < 0.05, invsimpson_test$p.value < 0.05)
)

print(alpha_stats)

# Save statistical results
write_tsv(alpha_stats, file.path(root_dir, "Alpha_Diversity_Statistics.tsv"))

```


#-------------------------------

# Beta Diversity Analysis

## Calculate Bray-Curtis Dissimilarity
```{r}
### ===========================
###   Calculate Bray-Curtis dissimilarity
### ===========================

# Calculate Bray-Curtis dissimilarity matrix
# This metric is widely used in ecology and microbiome studies
# It ranges from 0 (identical communities) to 1 (completely different communities)
bray_curtis_dist <- vegdist(rel_abundance_matrix, method = "bray")

# Display the dimensions of the distance matrix
cat("Bray-Curtis distance matrix dimensions:", attr(bray_curtis_dist, "Size"), "x", attr(bray_curtis_dist, "Size"), "\n")

```

## Principal Coordinates Analysis (PCoA)
```{r}
### ===========================
###   Perform PCoA on Bray-Curtis distances
### ===========================

# Perform Principal Coordinates Analysis (PCoA)
# This is an ordination technique that helps visualize dissimilarity between samples
pcoa_result <- pcoa(bray_curtis_dist)

# Calculate the percentage of variation explained by each axis
percent_explained <- round(pcoa_result$values$Relative_eig * 100, 2)

# Extract the coordinates of the first two principal axes
pcoa_coords <- data.frame(
  SampleID = rownames(pcoa_result$vectors),
  PC1 = pcoa_result$vectors[, 1],
  PC2 = pcoa_result$vectors[, 2]
) %>%
  left_join(metadata, by = "SampleID")

cat("\nVariance explained:\n")
cat("PC1:", percent_explained[1], "%\n")
cat("PC2:", percent_explained[2], "%\n")
cat("Total (PC1 + PC2):", sum(percent_explained[1:2]), "%\n")

```

```{r fig.width=8, fig.height=7}
### ===========================
###   Plot PCoA
### ===========================

# Calculate centroids for each group
centroids <- pcoa_coords %>%
  group_by(Group) %>%
  summarise(
    PC1_mean = mean(PC1),
    PC2_mean = mean(PC2),
    .groups = "drop"
  )

# Create PCoA plot
pcoa_plot <- ggplot(pcoa_coords, aes(x = PC1, y = PC2, color = Group, fill = Group)) +
  geom_point(size = 4, alpha = 0.7, shape = 21, stroke = 1.2) +
  scale_fill_manual(values = group_colors) +
  scale_color_manual(values = group_colors) +
  # Add centroids
  geom_point(data = centroids, aes(x = PC1_mean, y = PC2_mean),
             size = 6, shape = 23, color = "black", stroke = 1.5) +
  # Add labels for centroids
  geom_text_repel(data = centroids, aes(x = PC1_mean, y = PC2_mean, label = Group),
                  fontface = "bold", size = 5, box.padding = 1) +
  labs(
    x = paste0("PC1 (", percent_explained[1], "%)"),
    y = paste0("PC2 (", percent_explained[2], "%)"),
    title = "Beta Diversity: Principal Coordinates Analysis (PCoA)\nBray-Curtis Dissimilarity"
  ) +
  theme_boxplot() +
  theme(
    text = element_text(size = 14),
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    legend.position = "right",
    legend.title = element_text(size = 13, face = "bold"),
    legend.text = element_text(size = 12)
  )

print(pcoa_plot)

# Save the plot
ggsave(file.path(root_dir, "PCoA_BrayCurtis.pdf"),
       plot = pcoa_plot,
       device = "pdf",
       width = 8,
       height = 7,
       units = "in")

```

## PERMANOVA Test
```{r}
### ===========================
###   PERMANOVA: Test for differences in bacterial communities
### ===========================

# PERMANOVA (Permutational Multivariate Analysis of Variance)
# Tests whether the centroids and dispersions of groups differ
# H0: There is no difference in bacterial community composition between groups

# Prepare data for PERMANOVA
permanova_data <- metadata %>%
  filter(SampleID %in% rownames(rel_abundance_matrix))

# Perform PERMANOVA with 999 permutations
set.seed(123) # For reproducibility
permanova_result <- adonis2(
  bray_curtis_dist ~ Group,
  data = permanova_data,
  permutations = 999,
  method = "bray"
)

cat("\n=== PERMANOVA Results ===\n")
print(permanova_result)

# Extract key statistics
r2 <- permanova_result$R2[1]
pvalue <- permanova_result$`Pr(>F)`[1]

cat("\n=== Summary ===\n")
cat("R-squared:", round(r2, 4), "\n")
cat("P-value:", pvalue, "\n")
if (pvalue < 0.05) {
  cat("Result: Significant difference in community composition (p < 0.05)\n")
  cat("Interpretation: The bacterial communities differ significantly between Sjogren and Control groups.\n")
} else {
  cat("Result: No significant difference in community composition (p >= 0.05)\n")
  cat("Interpretation: The bacterial communities do not differ significantly between groups.\n")
}

```

## Betadisper: Test for Homogeneity of Dispersions
```{r}
### ===========================
###   Test for homogeneity of multivariate dispersions
### ===========================

# Betadisper tests whether the dispersion (spread) of samples differs between groups
# This is important because PERMANOVA assumes similar dispersion across groups

# Calculate beta-dispersion
betadisp_result <- betadisper(bray_curtis_dist, permanova_data$Group)

# Perform permutation test
set.seed(123)
betadisp_test <- permutest(betadisp_result, permutations = 999)

cat("\n=== Betadisper Results ===\n")
print(betadisp_test)

cat("\n=== Summary ===\n")
cat("P-value:", betadisp_test$tab$`Pr(>F)`[1], "\n")
if (betadisp_test$tab$`Pr(>F)`[1] < 0.05) {
  cat("Result: Significant difference in dispersion (p < 0.05)\n")
  cat("Interpretation: The groups have different levels of within-group variation.\n")
  cat("Note: PERMANOVA results should be interpreted with caution.\n")
} else {
  cat("Result: No significant difference in dispersion (p >= 0.05)\n")
  cat("Interpretation: The groups have similar levels of within-group variation.\n")
  cat("Note: PERMANOVA assumptions are met.\n")
}

```

```{r fig.width=7, fig.height=6}
### ===========================
###   Plot dispersion
### ===========================

# Extract distances to centroids for plotting
dispersion_distances <- data.frame(
  SampleID = names(betadisp_result$distances),
  Distance_to_Centroid = betadisp_result$distances,
  Group = betadisp_result$group
)

# Create boxplot of distances to centroid
dispersion_plot <- ggplot(dispersion_distances, aes(x = Group, y = Distance_to_Centroid, fill = Group)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.7, color = "black", linewidth = 0.6) +
  geom_beeswarm(aes(color = Group), alpha = 0.6, size = 3, cex = 3) +
  scale_fill_manual(values = group_colors) +
  scale_color_manual(values = group_colors) +
  labs(
    x = "",
    y = "Distance to Centroid",
    title = "Beta Diversity: Dispersion (Homogeneity Test)"
  ) +
  theme_boxplot() +
  theme(
    text = element_text(size = 14),
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    legend.position = "none"
  )

print(dispersion_plot)

# Save the plot
ggsave(file.path(root_dir, "Beta_Dispersion.pdf"),
       plot = dispersion_plot,
       device = "pdf",
       width = 7,
       height = 6,
       units = "in")

```

## Summary of Beta Diversity Tests
```{r}
### ===========================
###   Summary table of beta diversity statistics
### ===========================

beta_stats <- data.frame(
  Test = c("PERMANOVA", "Betadisper"),
  Statistic = c(
    paste0("F = ", round(permanova_result$F[1], 3)),
    paste0("F = ", round(betadisp_test$tab$F[1], 3))
  ),
  R2 = c(round(r2, 4), NA),
  P_value = c(
    permanova_result$`Pr(>F)`[1],
    betadisp_test$tab$`Pr(>F)`[1]
  ),
  Significant = c(
    permanova_result$`Pr(>F)`[1] < 0.05,
    betadisp_test$tab$`Pr(>F)`[1] < 0.05
  ),
  Interpretation = c(
    ifelse(permanova_result$`Pr(>F)`[1] < 0.05,
           "Communities differ significantly",
           "No significant difference in communities"),
    ifelse(betadisp_test$tab$`Pr(>F)`[1] < 0.05,
           "Dispersions differ significantly",
           "Dispersions are homogeneous")
  )
)

print(beta_stats)

# Save beta diversity statistics
write_tsv(beta_stats, file.path(root_dir, "Beta_Diversity_Statistics.tsv"))

```

**Interpretation of results:**

1. **Significant PERMANOVA (p=0.002):**
   - Bacterial communities of Sjogren and Control are CENTERED at different locations in multivariate space
   - There is a real change in bacterial composition associated with the disease

2. **Non-significant Betadisper (p=0.052):**
   - Within-group variability in Sjogren ≈ within-group variability in Control
   - Groups have homogeneous dispersions
   - VALIDATES that the difference detected by PERMANOVA is real and not an artifact of unequal dispersion

#-------------------------------

# Differential Abundance Analysis

## Identify Differentially Abundant Species
```{r}
### ===========================
###   Statistical tests for each species
### ===========================

# Perform Wilcoxon test for each species to identify those that differ
# significantly in abundance between Sjogren and Control groups

# FILTERING STRATEGY:
# For oral microbiome, we use a DUAL approach to capture both:
# 1. Prevalent species (core microbiome)
# 2. Rare but potentially important species (pathogens, biomarkers)

# MAIN ANALYSIS: Standard prevalence filter (recommended for most studies)
min_prevalence <- 0.1  # 10% of samples

species_prevalence <- abundance_data %>%
  group_by(Species) %>%
  summarize(
    Prevalence = sum(Abundance > 0) / n(),
    Mean_Abundance = mean(RelativeAbundance),
    .groups = "drop"
  ) %>%
  filter(Prevalence >= min_prevalence)

cat("\n=== Filtering Strategy ===\n")
cat("Prevalence threshold:", min_prevalence * 100, "%\n")
cat("Species passing filter:", nrow(species_prevalence), "\n")
cat("Species removed:", nrow(abundance_data %>% distinct(Species)) - nrow(species_prevalence), "\n")

# Perform Wilcoxon test for each prevalent species
differential_results <- abundance_data %>%
  filter(Species %in% species_prevalence$Species) %>%
  group_by(Species) %>%
  summarize(
    # Mean abundance in each group
    Mean_Sjogren = mean(RelativeAbundance[Group == "Sjogren"]),
    Mean_Control = mean(RelativeAbundance[Group == "Control"]),
    # Median abundance in each group
    Median_Sjogren = median(RelativeAbundance[Group == "Sjogren"]),
    Median_Control = median(RelativeAbundance[Group == "Control"]),
    # Log2 fold change (add pseudocount to avoid log(0))
    Log2FC = log2((Mean_Sjogren + 1e-6) / (Mean_Control + 1e-6)),
    # Wilcoxon test
    P_value = wilcox.test(
      RelativeAbundance[Group == "Sjogren"],
      RelativeAbundance[Group == "Control"]
    )$p.value,
    .groups = "drop"
  ) %>%
  # Apply multiple testing correction (Benjamini-Hochberg)
  mutate(
    P_adj = p.adjust(P_value, method = "BH"),
    Significant = P_adj < 0.05,
    Direction = case_when(
      Significant & Log2FC > 0 ~ "Enriched in Sjogren",
      Significant & Log2FC < 0 ~ "Enriched in Control",
      TRUE ~ "Not significant"
    )
  ) %>%
  arrange(P_adj)

# Display top differentially abundant species
cat("\n=== Top 20 Differentially Abundant Species ===\n")
print(head(differential_results, 20))

# Count significant species
n_significant <- sum(differential_results$Significant)
n_enriched_sjogren <- sum(differential_results$Direction == "Enriched in Sjogren")
n_enriched_control <- sum(differential_results$Direction == "Enriched in Control")

cat("\n=== Summary ===\n")
cat("Total species tested:", nrow(differential_results), "\n")
cat("Significant species (p.adj < 0.05):", n_significant, "\n")
cat("  - Enriched in Sjogren:", n_enriched_sjogren, "\n")
cat("  - Enriched in Control:", n_enriched_control, "\n")

# Save results
write_tsv(differential_results, file.path(root_dir, "Differential_Abundance_Results.tsv"))

```

## Volcano Plot
```{r fig.width=12, fig.height=9}
### ===========================
###   Volcano plot of differential abundance
### ===========================

# Create volcano plot showing log2 fold change vs -log10(p-value)
# ALL significant species will be labeled

volcano_plot <- differential_results %>%
  mutate(
    neg_log10_p = -log10(P_adj),
    # Label ALL significant species (not just those with |Log2FC| > 1)
    Label = ifelse(Significant, Species, "")
  ) %>%
  ggplot(aes(x = Log2FC, y = neg_log10_p, color = Direction)) +
  geom_point(size = 3, alpha = 0.6) +
  # Label all significant species
  geom_text_repel(
    aes(label = Label),
    size = 3.5,
    max.overlaps = Inf,  # Show ALL labels, no limit
    fontface = "italic",
    box.padding = 0.5,
    point.padding = 0.3,
    segment.color = "grey50",
    segment.size = 0.3,
    min.segment.length = 0
  ) +
  # Horizontal line: significance threshold (p.adj = 0.05)
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "gray30", linewidth = 0.8) +
  # Vertical lines: fold change thresholds (Log2FC = ±1)
  geom_vline(xintercept = c(-1, 1), linetype = "dashed", color = "gray30", linewidth = 0.8) +
  scale_color_manual(
    values = c(
      "Enriched in Sjogren" = "#0067b8",
      "Enriched in Control" = "#ff627c",
      "Not significant" = "gray70"
    )
  ) +
  labs(
    x = "Log2 Fold Change (Sjogren / Control)",
    y = "-Log10 (Adjusted P-value)",
    title = "Differential Abundance: Volcano Plot",
    color = "Differential Abundance"
  ) +
  theme_boxplot() +
  theme(
    text = element_text(size = 13),
    plot.title = element_text(hjust = 0.5, size = 15, face = "bold"),
    legend.position = "right",
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 11)
  )

print(volcano_plot)

# Save the plot
ggsave(file.path(root_dir, "Volcano_Plot_Differential_Abundance.pdf"),
       plot = volcano_plot,
       device = "pdf",
       width = 12,
       height = 9,
       units = "in")

```

## Rare Species Analysis (Supplementary)
```{r}
### ===========================
###   Analysis of rare but potentially important species
### ===========================

# SUPPLEMENTARY ANALYSIS: Rare species that may be biomarkers
# These are species with:
# - Low prevalence (5-10% of samples) BUT
# - High specificity to one group (mainly in Sjogren OR Control)

min_prevalence_rare <- 0.05  # 5% prevalence
max_prevalence_rare <- 0.10  # 10% prevalence

rare_species_candidates <- abundance_data %>%
  group_by(Species) %>%
  summarize(
    Overall_Prevalence = sum(Abundance > 0) / n(),
    Prevalence_Sjogren = sum(Abundance[Group == "Sjogren"] > 0) / sum(Group == "Sjogren"),
    Prevalence_Control = sum(Abundance[Group == "Control"] > 0) / sum(Group == "Control"),
    Mean_Abundance = mean(RelativeAbundance),
    .groups = "drop"
  ) %>%
  # Keep rare species (5-10% overall prevalence)
  filter(Overall_Prevalence >= min_prevalence_rare & Overall_Prevalence < max_prevalence_rare) %>%
  # Calculate prevalence difference between groups
  mutate(
    Prevalence_Diff = abs(Prevalence_Sjogren - Prevalence_Control),
    Specificity = case_when(
      Prevalence_Sjogren > Prevalence_Control * 2 ~ "Specific to Sjogren",
      Prevalence_Control > Prevalence_Sjogren * 2 ~ "Specific to Control",
      TRUE ~ "Not specific"
    )
  ) %>%
  # Keep only those with clear group specificity
  filter(Specificity != "Not specific") %>%
  arrange(desc(Prevalence_Diff))

cat("\n=== Rare Species Analysis ===\n")
cat("Prevalence range:", min_prevalence_rare * 100, "% -", max_prevalence_rare * 100, "%\n")
cat("Rare species found:", nrow(rare_species_candidates), "\n")
cat("  - Specific to Sjogren:", sum(rare_species_candidates$Specificity == "Specific to Sjogren"), "\n")
cat("  - Specific to Control:", sum(rare_species_candidates$Specificity == "Specific to Control"), "\n")

if (nrow(rare_species_candidates) > 0) {
  cat("\n=== Top Rare Species Candidates ===\n")
  print(head(rare_species_candidates, 10))

  # Save rare species results
  write_tsv(rare_species_candidates,
            file.path(root_dir, "Rare_Species_Biomarker_Candidates.tsv"))
} else {
  cat("\nNo rare species with strong group specificity found.\n")
}

```

## Combined Results Summary
```{r}
### ===========================
###   Summary of all differential abundance findings
### ===========================

cat("\n=== COMPLETE DIFFERENTIAL ABUNDANCE SUMMARY ===\n\n")

cat("1. PREVALENT SPECIES (Main Analysis):\n")
cat("   - Prevalence threshold: ≥", min_prevalence * 100, "%\n")
cat("   - Species tested:", nrow(differential_results), "\n")
cat("   - Significant species:", sum(differential_results$Significant), "\n")
cat("     * Enriched in Sjogren:", sum(differential_results$Direction == "Enriched in Sjogren"), "\n")
cat("     * Enriched in Control:", sum(differential_results$Direction == "Enriched in Control"), "\n\n")

cat("2. RARE SPECIES (Supplementary Analysis):\n")
cat("   - Prevalence range:", min_prevalence_rare * 100, "% -", max_prevalence_rare * 100, "%\n")
cat("   - Group-specific species:", nrow(rare_species_candidates), "\n")
if (nrow(rare_species_candidates) > 0) {
  cat("     * Specific to Sjogren:", sum(rare_species_candidates$Specificity == "Specific to Sjogren"), "\n")
  cat("     * Specific to Control:", sum(rare_species_candidates$Specificity == "Specific to Control"), "\n")
}

cat("\n=== INTERPRETATION ===\n")
cat("Prevalent species: Represent core microbiome differences\n")
cat("Rare species: Potential pathogenic/protective organisms or biomarkers\n")

```


#-------------------------------

# Session Information
```{r}
### ===========================
###   Session information
### ===========================

# Display session information for reproducibility
sessionInfo()

```
